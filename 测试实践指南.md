# Android单元测试标准化实践示例

本项目是根据《Android单元测试标准化研究.md》文档创建的完整实践示例，展示了如何按照**依赖复杂度分层**的方式组织和实施Android单元测试。

## 🎯 项目结构

### 📂 业务逻辑层
```
app/src/main/java/com/oneblue3/unicasetest/
├── logic/              # 🚀 纯逻辑类 - 无外部依赖
│   ├── Calculator.java      # 数学计算逻辑
│   └── UserValidator.java   # 用户验证逻辑
├── utils/              # 🔧 工具组件 - 有Android依赖
│   └── FileUtil.java       # 文件操作工具类
└── network/            # 🔧 网络组件 - 有网络依赖
    └── NetworkUtil.java    # HTTP请求工具类
```

### 📂 测试代码层
```
app/src/test/java/com/oneblue3/unicasetest/
├── logic/              # 🚀 纯逻辑测试 (60%)
│   ├── CalculatorTest.java      # JUnit 5 + Truth
│   └── UserValidatorTest.java   # 参数化测试示例
├── utils/              # 🔧 组件测试 (30%)
│   └── FileUtilTest.java       # Robolectric测试
├── network/            # 🔧 组件测试 (30%)
│   └── NetworkUtilTest.java    # MockWebServer测试
└── AllTestsSuite.java  # 测试套件组织

app/src/androidTest/java/com/oneblue3/unicasetest/
└── ui/                 # 🖥️ 界面测试 (10%)
    └── MainActivityUITest.java # Espresso测试
```

## 🚀 快速开始

### 1. 运行纯逻辑测试（日常开发）
```bash
# 运行所有纯逻辑测试 - 最快反馈
./gradlew test --tests "*logic*"

# 运行特定测试类
./gradlew test --tests "CalculatorTest"
./gradlew test --tests "UserValidatorTest"
```

**特点**：
- ⚡ 执行时间：< 5秒
- 🎯 覆盖率目标：> 95%
- 💡 适用场景：TDD开发、快速验证业务逻辑

### 2. 运行组件测试（集成验证）
```bash
# 运行所有组件测试
./gradlew test --tests "*utils*" --tests "*network*"

# 运行Android组件测试
./gradlew test --tests "FileUtilTest"

# 运行网络组件测试  
./gradlew test --tests "NetworkUtilTest"
```

**特点**：
- ⚡ 执行时间：< 30秒
- 🔧 技术栈：Robolectric + MockWebServer + Mockito
- 💡 适用场景：验证外部依赖、集成测试

### 3. 运行界面测试（发布验证）
```bash
# 启动模拟器或连接设备
adb devices

# 运行UI测试
./gradlew connectedAndroidTest

# 运行特定UI测试
./gradlew connectedAndroidTest -Pandroid.testInstrumentationRunnerArguments.class=com.oneblue3.unicasetest.ui.MainActivityUITest
```

**特点**：
- ⚡ 执行时间：< 5分钟
- 🖥️ 技术栈：Espresso + AndroidJUnitRunner
- 💡 适用场景：端到端验证、关键用户路径测试

### 4. 完整测试流程
```bash
# 步骤1：运行单元测试（纯逻辑 + 组件）
./gradlew test

# 步骤2：运行界面测试
./gradlew connectedAndroidTest

# 步骤3：生成测试报告
./gradlew testDebugUnitTestCoverage
```

## 📊 测试层级详解

### 🚀 第一层：纯逻辑测试 (60%)

**目标**：验证核心业务逻辑，无任何外部依赖

**示例类**：
- `Calculator` - 数学计算逻辑
- `UserValidator` - 数据验证规则

**测试框架**：
```kotlin
testImplementation("org.junit.jupiter:junit-jupiter:5.10.0")
testImplementation("com.google.truth:truth:1.1.5")
```

**最佳实践**：
- ✅ 毫秒级执行时间
- ✅ 参数化测试覆盖边界条件
- ✅ 使用Truth断言库提高可读性
- ✅ 支持TDD开发模式

### 🔧 第二层：组件测试 (30%)

**目标**：验证有外部依赖的组件，但在受控环境中运行

**示例类**：
- `FileUtil` - Android文件操作（使用Robolectric）
- `NetworkUtil` - HTTP请求处理（使用MockWebServer）

**测试框架**：
```kotlin
testImplementation("org.robolectric:robolectric:4.11.1")
testImplementation("com.squareup.okhttp3:mockwebserver:4.12.0")
testImplementation("org.mockito:mockito-core:5.5.0")
```

**最佳实践**：
- ✅ 秒级执行时间
- ✅ 模拟外部依赖行为
- ✅ 验证边界条件和异常处理
- ✅ 保持测试的确定性

### 🖥️ 第三层：界面测试 (10%)

**目标**：验证端到端用户交互，关注核心业务流程

**示例场景**：
- 主页面导航切换
- 用户注册完整流程
- 跨Fragment数据传递

**测试框架**：
```kotlin
androidTestImplementation("androidx.test.espresso:espresso-core:3.5.1")
androidTestImplementation("androidx.test:runner:1.5.2")
```

**最佳实践**：
- ✅ 专注核心用户路径
- ✅ 避免测试UI细节
- ✅ 保持测试稳定性
- ✅ 模拟真实用户操作

## 🎯 性能基准与目标

| 测试层级 | 执行时间目标 | 覆盖率目标 | 主要价值 |
|---------|-------------|-----------|----------|
| 🚀 纯逻辑测试 | < 5秒 | > 95% | 快速反馈、TDD支持 |
| 🔧 组件测试 | < 30秒 | > 85% | 依赖验证、集成测试 |
| 🖥️ 界面测试 | < 5分钟 | 核心路径100% | 用户体验保障 |

## 🛠️ 开发工作流建议

### 日常开发
1. **红绿重构循环**：编写纯逻辑测试 → 实现功能 → 重构优化
2. **快速验证**：主要运行纯逻辑测试获得即时反馈
3. **定期检查**：每日运行完整的单元测试套件

### 集成阶段
1. **完整验证**：运行所有层级的测试
2. **性能监控**：确保测试执行时间在目标范围内
3. **覆盖率检查**：验证代码覆盖率达到目标

### 发布前
1. **端到端测试**：重点运行界面测试验证用户体验
2. **回归测试**：运行完整测试套件确保无回归问题
3. **测试报告**：生成详细的测试报告和覆盖率分析

## 🔍 故障排除

### 常见问题

1. **Robolectric测试失败**
   ```bash
   # 检查SDK版本配置
   @Config(sdk = {29})
   
   # 确保资源访问配置
   android.testOptions.unitTests.isIncludeAndroidResources = true
   ```

2. **MockWebServer端口冲突**
   ```java
   // 使用动态端口
   mockServer = new MockWebServer();
   mockServer.start(0); // 自动分配端口
   ```

3. **UI测试不稳定**
   ```kotlin
   // 禁用动画
   android.testOptions.animationsDisabled = true
   ```

## 📚 参考资料

- [Android单元测试标准化研究.md](./Android单元测试标准化研究.md) - 完整的理论指导
- [JUnit 5官方文档](https://junit.org/junit5/docs/current/user-guide/)
- [Truth断言库](https://truth.dev/)
- [Robolectric文档](http://robolectric.org/)
- [Espresso测试指南](https://developer.android.com/training/testing/espresso)

## 🤝 贡献指南

1. 遵循三层测试架构原则
2. 保持测试的快速执行和稳定性
3. 优先编写纯逻辑测试
4. 界面测试只关注核心用户路径
5. 确保测试代码的可读性和可维护性